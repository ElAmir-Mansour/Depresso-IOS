<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depresso Research Dashboard - Dark</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', system-ui, sans-serif;
            background: #0a0e27;
            background-image:
                radial-gradient(ellipse at top, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
            min-height: 100vh;
            padding: 30px;
            color: #e2e8f0;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(30px) saturate(180%);
            padding: 40px;
            border-radius: 24px;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(99, 102, 241, 0.1) inset;
            margin-bottom: 30px;
            border: 1px solid rgba(99, 102, 241, 0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #6366f1, #8b5cf6, transparent);
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .header h1 {
            font-size: 36px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .header p {
            color: #94a3b8;
            font-size: 15px;
            font-weight: 400;
        }

        .export-section {
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .export-section label {
            color: #cbd5e1;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .export-select {
            padding: 12px 20px;
            background: rgba(30, 41, 59, 0.8);
            border: 1.5px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .export-select:hover {
            border-color: #6366f1;
            background: rgba(30, 41, 59, 1);
            transform: translateY(-1px);
        }

        .export-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.5);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: rgba(17, 24, 39, 0.6);
            padding: 8px;
            border-radius: 16px;
            backdrop-filter: blur(20px);
        }

        .tab {
            padding: 14px 24px;
            background: transparent;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #94a3b8;
        }

        .tab.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow:
                0 8px 20px rgba(99, 102, 241, 0.4),
                0 0 0 1px rgba(99, 102, 241, 0.5) inset;
            transform: translateY(-2px);
        }

        .tab:hover:not(.active) {
            background: rgba(99, 102, 241, 0.1);
            color: #cbd5e1;
            transform: translateY(-1px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(30px) saturate(180%);
            padding: 32px;
            border-radius: 20px;
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(99, 102, 241, 0.1) inset;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(99, 102, 241, 0.15);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(99, 102, 241, 0.3) inset;
            border-color: rgba(99, 102, 241, 0.4);
        }

        .stat-card h3 {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 16px;
            font-weight: 700;
        }

        .stat-card .value {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            line-height: 1.1;
            position: relative;
            z-index: 1;
        }

        .stat-card .label {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }

        .content-section {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(30px) saturate(180%);
            padding: 32px;
            border-radius: 20px;
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(99, 102, 241, 0.1) inset;
            border: 1px solid rgba(99, 102, 241, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chart-card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-4px);
            box-shadow:
                0 15px 50px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(99, 102, 241, 0.2) inset;
        }

        .chart-card h2 {
            font-size: 18px;
            color: #e2e8f0;
            margin-bottom: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-card h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 2px;
        }

        .table-container {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(30px) saturate(180%);
            padding: 32px;
            border-radius: 20px;
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(99, 102, 241, 0.1) inset;
            overflow-x: auto;
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: #cbd5e1;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.3);
        }

        th:first-child {
            border-top-left-radius: 12px;
        }

        th:last-child {
            border-top-right-radius: 12px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            color: #94a3b8;
            font-size: 14px;
        }

        tr:hover td {
            background: rgba(99, 102, 241, 0.05);
        }

        .loading {
            text-align: center;
            padding: 100px 20px;
            color: #94a3b8;
            font-size: 16px;
        }

        .spinner {
            display: inline-block;
            width: 60px;
            height: 60px;
            border: 5px solid rgba(99, 102, 241, 0.1);
            border-top: 5px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: rgba(239, 68, 68, 0.15);
            border-left: 4px solid #ef4444;
            padding: 20px;
            border-radius: 12px;
            color: #fca5a5;
            margin: 20px 0;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .refresh-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .refresh-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.5);
        }

        code {
            background: rgba(99, 102, 241, 0.15);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: #a5b4fc;
            font-family: 'Monaco', 'Menlo', monospace;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        canvas {
            filter: drop-shadow(0 4px 16px rgba(0, 0, 0, 0.3));
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üß† Research Analytics Dashboard</h1>
            <p>Real-time insights from Depresso mental health research data with RAG-powered analysis</p>
        </div>

        <div class="export-section">
            <label>üì• Export Data:</label>
            <select id="exportTable" class="export-select">
                <option value="journalentries">Journal Entries</option>
                <option value="assessments">PHQ-8 Assessments</option>
                <option value="users">User Data</option>
            </select>
            <button class="export-btn" onclick="exportData()">
                <span>‚¨áÔ∏è</span>
                <span>Download CSV</span>
            </button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
            <button class="tab" onclick="switchTab('sentiment')">üòä Sentiment</button>
            <button class="tab" onclick="switchTab('cbt')">üß† CBT Distortions</button>
            <button class="tab" onclick="switchTab('assessments')">üìã PHQ-8</button>
            <button class="tab" onclick="switchTab('entries')">üìù Entries</button>
            <button class="tab" onclick="switchTab('community')">üë• Community</button>
        </div>

        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>Loading research data...</p>
        </div>

        <!-- Overview Section -->
        <div id="overview" class="content-section active">
            <div class="stats-grid" id="overviewStats"></div>
            <button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh All Data</button>
        </div>

        <!-- Sentiment Analysis Section -->
        <div id="sentiment" class="content-section">
            <div class="chart-grid">
                <div class="chart-card">
                    <h2>Sentiment Over Time</h2>
                    <canvas id="sentimentChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Sentiment Distribution</h2>
                    <canvas id="sentimentDistChart"></canvas>
                </div>
            </div>
        </div>

        <!-- CBT Distortions Section -->
        <div id="cbt" class="content-section">
            <div class="chart-grid">
                <div class="chart-card">
                    <h2>Top Cognitive Distortions</h2>
                    <canvas id="distortionsChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Distortions Over Time</h2>
                    <canvas id="distortionsTimeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- PHQ-8 Assessments Section -->
        <div id="assessments" class="content-section">
            <div class="chart-grid">
                <div class="chart-card">
                    <h2>Severity Distribution</h2>
                    <canvas id="assessmentDistChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Average Scores Over Time</h2>
                    <canvas id="assessmentTimeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Research Entries Section -->
        <div id="entries" class="content-section">
            <div class="table-container">
                <h2 style="margin-bottom: 24px; color: #e2e8f0; font-size: 20px; font-weight: 700;">Recent Research
                    Submissions</h2>
                <div id="entriesTable"></div>
            </div>
        </div>

        <!-- Community Section -->
        <div id="community" class="content-section">
            <div class="stats-grid" id="communityStats"></div>
            <div class="chart-grid">
                <div class="chart-card">
                    <h2>Community Engagement Trends</h2>
                    <canvas id="communityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api/v1/research';
        let charts = {};

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(51, 65, 85, 0.3)';

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        }

        async function loadAllData() {
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                await Promise.all([
                    loadOverview(),
                    loadSentiment(),
                    loadCBT(),
                    loadAssessments(),
                    loadEntries(),
                    loadCommunity()
                ]);
            } catch (error) {
                console.error('Error loading data:', error);
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function loadOverview() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const data = await response.json();
                
                const statsHtml = `
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value">${data.total_users || 0}</div>
                        <div class="label">Registered participants</div>
                    </div>
                    <div class="stat-card">
                        <h3>Journal Entries</h3>
                        <div class="value">${data.total_entries || 0}</div>
                        <div class="label">Written submissions</div>
                    </div>
                    <div class="stat-card">
                        <h3>Assessments</h3>
                        <div class="value">${data.total_assessments || 0}</div>
                        <div class="label">PHQ-8 completed</div>
                    </div>
                    <div class="stat-card">
                        <h3>AI Messages</h3>
                        <div class="value">${data.total_messages || 0}</div>
                        <div class="label">RAG conversations</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Sentiment</h3>
                        <div class="value">${parseFloat(data.avg_sentiment || 0).toFixed(2)}</div>
                        <div class="label">Overall mood score</div>
                    </div>
                    <div class="stat-card">
                        <h3>Risk Flags</h3>
                        <div class="value" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${data.risk_flags || 0}</div>
                        <div class="label">Requiring attention</div>
                    </div>
                `;
                
                document.getElementById('overviewStats').innerHTML = statsHtml;
            } catch (error) {
                console.error('Overview error:', error);
                document.getElementById('overviewStats').innerHTML = '<div class="error">Failed to load overview stats</div>';
            }
        }

        async function loadSentiment() {
            try {
                const response = await fetch(`${API_BASE}/sentiment?days=30`);
                const data = await response.json();
                
                if (charts.sentimentChart) charts.sentimentChart.destroy();
                const ctx1 = document.getElementById('sentimentChart').getContext('2d');
                charts.sentimentChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: data.timeSeries.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Average Sentiment',
                            data: data.timeSeries.map(d => d.avg_sentiment),
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointBackgroundColor: '#6366f1',
                            pointBorderColor: '#1e293b',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(51, 65, 85, 0.3)' } },
                            x: { grid: { color: 'rgba(51, 65, 85, 0.2)' } }
                        }
                    }
                });
                
                if (charts.sentimentDistChart) charts.sentimentDistChart.destroy();
                const ctx2 = document.getElementById('sentimentDistChart').getContext('2d');
                charts.sentimentDistChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: data.distribution.map(d => d.category),
                        datasets: [{
                            data: data.distribution.map(d => d.count),
                            backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true }
                });
            } catch (error) {
                console.error('Sentiment error:', error);
            }
        }

        async function loadCBT() {
            try {
                const response = await fetch(`${API_BASE}/distortions`);
                const data = await response.json();
                
                if (charts.distortionsChart) charts.distortionsChart.destroy();
                const ctx1 = document.getElementById('distortionsChart').getContext('2d');
                charts.distortionsChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: data.frequency.map(d => d.distortion),
                        datasets: [{
                            label: 'Occurrences',
                            data: data.frequency.map(d => d.count),
                            backgroundColor: 'rgba(139, 92, 246, 0.8)',
                            borderRadius: 8,
                            borderColor: '#8b5cf6',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(51, 65, 85, 0.2)' } },
                            x: { grid: { color: 'rgba(51, 65, 85, 0.3)' } }
                        }
                    }
                });
                
                if (charts.distortionsTimeChart) charts.distortionsTimeChart.destroy();
                const ctx2 = document.getElementById('distortionsTimeChart').getContext('2d');
                charts.distortionsTimeChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: data.timeSeries.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Total Distortions',
                            data: data.timeSeries.map(d => d.total_distortions),
                            borderColor: '#ec4899',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointBackgroundColor: '#ec4899',
                            pointBorderColor: '#1e293b',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: { 
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(51, 65, 85, 0.3)' } },
                            x: { grid: { color: 'rgba(51, 65, 85, 0.2)' } }
                        }
                    }
                });
            } catch (error) {
                console.error('CBT error:', error);
            }
        }

        async function loadAssessments() {
            try {
                const response = await fetch(`${API_BASE}/assessments`);
                const data = await response.json();
                
                if (charts.assessmentDistChart) charts.assessmentDistChart.destroy();
                const ctx1 = document.getElementById('assessmentDistChart').getContext('2d');
                charts.assessmentDistChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: data.distribution.map(d => d.severity),
                        datasets: [{
                            data: data.distribution.map(d => d.count),
                            backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#991b1b'],
                            borderWidth: 0
                        }]
                    },
                    options: { responsive: true }
                });
                
                if (charts.assessmentTimeChart) charts.assessmentTimeChart.destroy();
                const ctx2 = document.getElementById('assessmentTimeChart').getContext('2d');
                charts.assessmentTimeChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: data.timeSeries.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Average PHQ-8 Score',
                            data: data.timeSeries.map(d => d.avg_score),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#1e293b',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: { 
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(51, 65, 85, 0.3)' } },
                            x: { grid: { color: 'rgba(51, 65, 85, 0.2)' } }
                        }
                    }
                });
            } catch (error) {
                console.error('Assessments error:', error);
            }
        }

        async function loadEntries() {
            try {
                const response = await fetch(`${API_BASE}/entries`);
                const data = await response.json();
                
                const table = `
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Prompt ID</th>
                                <th>Content</th>
                                <th>Sentiment</th>
                                <th>Tags</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(entry => `
                                <tr>
                                    <td>${new Date(entry.created_at).toLocaleString()}</td>
                                    <td><code>${entry.prompt_id}</code></td>
                                    <td>${(entry.content || '').substring(0, 100)}...</td>
                                    <td>${entry.sentiment_label || 'N/A'}</td>
                                    <td>${(entry.tags || []).join(', ')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                document.getElementById('entriesTable').innerHTML = table;
            } catch (error) {
                console.error('Entries error:', error);
                document.getElementById('entriesTable').innerHTML = '<div class="error">Failed to load entries</div>';
            }
        }

        async function loadCommunity() {
            try {
                const response = await fetch(`${API_BASE}/community/stats`);
                const data = await response.json();
                
                const statsHtml = `
                    <div class="stat-card">
                        <h3>Total Posts</h3>
                        <div class="value">${data.overview.total_posts || 0}</div>
                        <div class="label">Community posts</div>
                    </div>
                    <div class="stat-card">
                        <h3>Comments</h3>
                        <div class="value">${data.overview.total_comments || 0}</div>
                        <div class="label">Conversations</div>
                    </div>
                    <div class="stat-card">
                        <h3>Likes</h3>
                        <div class="value">${data.overview.total_likes || 0}</div>
                        <div class="label">Positive reactions</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Reports</h3>
                        <div class="value" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${data.overview.pending_reports || 0}</div>
                        <div class="label">Moderation queue</div>
                    </div>
                `;
                
                document.getElementById('communityStats').innerHTML = statsHtml;
                
                if (charts.communityChart) charts.communityChart.destroy();
                const ctx = document.getElementById('communityChart').getContext('2d');
                charts.communityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.timeSeries.map(d => new Date(d.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Posts',
                            data: data.timeSeries.map(d => d.posts),
                            borderColor: '#3b82f6',
                            yAxisID: 'y',
                            borderWidth: 3,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#1e293b',
                            pointBorderWidth: 2
                        }, {
                            label: 'Views',
                            data: data.timeSeries.map(d => d.views),
                            borderColor: '#10b981',
                            yAxisID: 'y1',
                            borderWidth: 3,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#1e293b',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { type: 'linear', position: 'left', grid: { color: 'rgba(51, 65, 85, 0.3)' } },
                            y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false, color: 'rgba(51, 65, 85, 0.2)' } }
                        }
                    }
                });
            } catch (error) {
                console.error('Community error:', error);
            }
        }

        function exportData() {
            const table = document.getElementById('exportTable').value;
            const url = `${API_BASE}/export?table=${table}`;
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${table}_export.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span>‚úÖ</span><span>Downloaded!</span>';
            btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 2000);
        }

        loadAllData();
    </script>
</body>

</html>