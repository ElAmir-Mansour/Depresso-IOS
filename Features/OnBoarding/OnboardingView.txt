// In Features/Onboarding/OnboardingView.swift
import SwiftUI
import ComposableArchitecture

struct OnboardingView: View {
    let store: StoreOf<OnboardingFeature>

    var body: some View {
        WithViewStore(self.store, observe: { $0 }) { viewStore in
            VStack {
                if viewStore.isCompleted {
                    analysisView(viewStore)
                } else {
                    questionView(viewStore)
                }
            }
            .animation(.default, value: viewStore.currentQuestionIndex)
            .animation(.default, value: viewStore.isCompleted)
        }
    }

    @ViewBuilder
    private func questionView(_ viewStore: ViewStoreOf<OnboardingFeature>) -> some View {
        VStack(spacing: DesignSystem.Spacing.large) {
            Text("How have you been feeling?")
                .font(.ds.title)
                .padding(.horizontal)

            ProgressView(value: viewStore.progress)
                .padding(.horizontal)
                .tint(.ds.accent)

            let currentQuestion = viewStore.questions[viewStore.currentQuestionIndex]
            VStack {
                Text("Over the last 2 weeks, how often have you been bothered by:")
                    .font(.ds.caption)
                    .foregroundStyle(.secondary)
                Text(currentQuestion.text)
                    .font(.ds.headline)
                    .multilineTextAlignment(.center)
                    .padding()
            }
            .frame(minHeight: 150, alignment: .center)


            VStack(spacing: DesignSystem.Spacing.medium) {
                ForEach(PHQ8.Answer.allCases, id: \.self) { answer in
                    Button {
                        viewStore.send(.answerQuestion(index: viewStore.currentQuestionIndex, answer: answer))
                    } label: {
                        Text(answer.description)
                            .frame(maxWidth: .infinity)
                            .padding()
                            .background(
                                viewStore.questions[viewStore.currentQuestionIndex].answer == answer ?
                                    Color.ds.accent : Color(UIColor.secondarySystemGroupedBackground)
                            )
                            .foregroundStyle(
                                viewStore.questions[viewStore.currentQuestionIndex].answer == answer ?
                                    .white : .primary
                            )
                            .clipShape(RoundedRectangle(cornerRadius: 12))
                    }
                }
            }
            .padding(.horizontal)

            Spacer()

            HStack {
                if viewStore.currentQuestionIndex > 0 {
                    Button("Back") {
                        viewStore.send(.backButtonTapped)
                    }
                    .padding()
                }

                Spacer()

                Button(viewStore.currentQuestionIndex < viewStore.questions.count - 1 ? "Next" : "Finish") {
                    viewStore.send(.nextButtonTapped)
                }
                .padding()
                .background(Color.ds.accent)
                .foregroundStyle(.white)
                .clipShape(Capsule())
                .disabled(!viewStore.isNextButtonEnabled)
            }
            .padding()
        }
    }

    @ViewBuilder
    private func analysisView(_ viewStore: ViewStoreOf<OnboardingFeature>) -> some View {
        VStack(alignment: .leading, spacing: DesignSystem.Spacing.large) {
            Text("Thank You for Sharing")
                .font(.ds.title)

            if let analysis = viewStore.analysis {
                ScrollView {
                    Text(analysis)
                        .font(.ds.body)
                }

                Spacer()

                Button("Get Started") {
                    viewStore.send(.delegate(.onboardingCompleted))
                }
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color.ds.accent)
                .foregroundStyle(.white)
                .clipShape(Capsule())

            } else {
                VStack(spacing: DesignSystem.Spacing.medium) {
                    Text("We're preparing a personalized analysis of your results to help you get the most out of Depresso.")
                        .font(.ds.body)
                    
                    if viewStore.isLoadingAnalysis {
                        ProgressView()
                            .padding()
                    }
                }


                Spacer()

                Button("Get My Analysis") {
                    viewStore.send(.getAnalysisButtonTapped)
                }
                .frame(maxWidth: .infinity)
                .padding()
                .background(Color.ds.accent)
                .foregroundStyle(.white)
                .clipShape(Capsule())
                .disabled(viewStore.isLoadingAnalysis)
            }
        }
        .padding()
    }
}
